<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="stylesheet" href="res/jquery-mobile.min.css" />
        <link rel="stylesheet" href="res/style.css" />

        <script type="text/javascript" src="libs/js/jquery.min.js"></script>
        <script type="text/javascript" src="libs/js/jquery-mobile.min.js"></script>
        <script type="text/javascript" src="libs/js/projectbase.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
        <script type="text/javascript">
            var LinkServer = null, db = null;
            
            $(function () {
                //Initialize variables
                LinkServer = new Linker('http://192.227.159.91/pot/');
                LinkServer.setExtension(".json?");
                
                //Create connection to the DB
                db = window.openDatabase("pot", "1.0", "POT Database", 5 * 1024 * 1024);
                
                //Create tables to the DB
                db.transaction(function (tx) {
                    //tx.executeSql('DROP TABLE IF EXISTS version');
                    //tx.executeSql('DROP TABLE IF EXISTS sector');
                    //tx.executeSql('DROP TABLE IF EXISTS puntos');
                    //tx.executeSql('DROP TABLE IF EXISTS valores');
                    
                    tx.executeSql('CREATE TABLE IF NOT EXISTS version (idversion unique, version)');
                    tx.executeSql('CREATE TABLE IF NOT EXISTS sector (idsector unique, nombre, tipo)');
                    tx.executeSql('CREATE TABLE IF NOT EXISTS puntos (idpuntos unique, idsector, x, y)');
                    tx.executeSql('CREATE TABLE IF NOT EXISTS valores (idvalores unique, idsector, mes, min, max, prom)');
                    
                    //Find for a new version of data
                    tx.executeSql('INSERT OR IGNORE INTO version (idversion, version) VALUES (?, ?)', [1, 0]);
                    tx.executeSql('SELECT version FROM version', [], updateVersion);
                }, error, success);
            });
            
            function updateVersion (_tx, result) {
                //Get the last version on the application
                var version = (result.rows.length > 0)? result.rows.item(0).version : 0;
                
                //Find on the server for a new version
                uget({
                    url: LinkServer.Url('version', 'ref')
                }).done(function (data) {
                    //If a new version was found, update!
                    var updated = [false, false, false];
                    
                    if(data._response.version > version) {
                        console.log("A new version was Found! Updating...");
                        
                        //Delete old information and update the version ID
                        db.transaction(function (tx) {
                            tx.executeSql('UPDATE version SET version = ? WHERE idversion = 1', [data._response.version]);
                            tx.executeSql('DELETE FROM valores WHERE idvalores > 0');
                            tx.executeSql('DELETE FROM puntos WHERE idpuntos > 0');
                            tx.executeSql('DELETE FROM sector WHERE idsector > 0');
                        });
                        
                        //Get the new sector
                        uget({
                            url: LinkServer.Url('sector', 'get')
                        }).done(function (data) {
                            db.transaction(function (tx) {
                                for(var i in data._response) {
                                    var ob = data._response[i];
                                    tx.executeSql(
                                        'INSERT INTO sector (idsector, nombre, tipo) VALUES (?, ?, ?)',
                                        [ob.idsector, ob.nombre, ob.tipo]
                                    );
                                }
                            }, error, function () {
                                updated[0] = true;
                            });
                            
                        });
                        
                        //Get the new puntos
                        uget({
                            url: LinkServer.Url('puntos', 'get')
                        }).done(function (data) {
                            db.transaction(function (tx) {
                                for(var i in data._response) {
                                    var ob = data._response[i];
                                    tx.executeSql(
                                        'INSERT INTO puntos (idpuntos, idsector, x, y) VALUES (?, ?, ?, ?)',
                                        [ob.idpuntos, ob.idsector, ob.x, ob.y]
                                    );
                                }
                            }, error, function () {
                                updated[1] = true;
                            });
                            
                        });
                        
                        //Get the new valores
                        uget({
                            url: LinkServer.Url('valores', 'get')
                        }).done(function (data) {
                            db.transaction(function (tx) {
                                for(var i in data._response) {
                                    var ob = data._response[i];
                                    tx.executeSql(
                                        'INSERT INTO valores (idvalores, idsector, mes, max, min, prom) VALUES (?, ?, ?, ?, ?, ?)',
                                        [ob.idvalores, ob.idsector, ob.mes, ob.max, ob.min, ob.prom]
                                    );
                                }
                            }, error, function () {
                                updated[2] = true;
                            });
                            
                        });
                    } else {
                        for(var i=0; i<updated.length; i++) {
                            updated[i] = true;
                        }
                    }
                    
                    (function onComplete () {
                        var sw = true;
                        for(var i=0; i<updated.length && sw; i++) {
                            sw = updated[i];
                        }
                        
                        if(sw) {
                            generatePol();
                        } else {
                            setTimeout(onComplete, 150);
                        }
                    })();
                });
            }
            
            function generatePol () {
                console.log("hola mundo");
                //hola mundo
            }

            // Transaction error callback
            //
            function error(err) {
                console.log(err.message);
            }

            // Transaction success callback
            //
            function success() {}

            function initialize() {
                var mapOptions = {
                    center: new google.maps.LatLng(-34.397, 150.644),
                    disableDefaultUI: true,
                    zoom: 8
                };

                var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
            }

            google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </head>
    <body>
        <div data-role="page" id="pageone">
            <div data-role="header" data-position="fixed">
                <h1>Welcome To My Homepage</h1>
            </div>

            <div data-role="content">
                <div id="map-canvas"></div>
            </div>
        </div> 

        <div data-role="page" id="pagetwo">
            <div data-role="header">
                <h1>I'm A Dialog Box!</h1>
            </div>

            <div data-role="content">
                <p>The dialog box is different from a normal page, it is displayed on top of the current page with a dark background color. It will not span the entire width of the page. The dialog has an icon of "X" in the header to close the box.</p>
                <a href="#pageone">Go to Page One</a>
            </div>

            <div data-role="footer">
                <h1>Footer Text</h1>
            </div>
        </div> 
    </body>
</html>
